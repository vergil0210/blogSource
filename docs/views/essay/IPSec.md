---
title: IPSec框架学习随笔
date: 2020-06-19
categories:
- essay
tags:
- Network
- security
---

## 1. 简介

IPSec（Internet Protocol Security）互联网安全协议，是一个协议包（安全框架），通过对IP协议的分组进行加密和认证来保护IP协议的网络传输协议组。主要由**AH（Authentication Header）认证报头、ESP（Encapsulating Security Payload）封装安全载荷、IKE（Internet Key Exchange）因特网密钥** 三个协议组成。

## 2. 应用

IPsec被设计用于提供一下几个功能：

- 通过IPsec可以在互联网或者共用WAN上建立一个安全的虚拟专用网络
- 允许用户通过互联网进行安全的远程访问
- 使用IPSec实现和其他组织的安全通信，IPSec可以确保认证、保密并提供密钥交换机制。
- 加强电子商务安全性

## 3. 子协议及相关概念简介

### 3.1 安全关联（SA）

####  定义

安全关联是单向的，在两个使用IPSec的实体(主机或路由器)间建立的逻辑连接，定义了实体间如何使用安全服务(如加密)进行通信。它由3个元素——**安全参数索引SPI**、**IP目的地址**和**安全协议标识**组成。安全关联是发送方和接收方之间用于对他们之间传递的数据流提供安全服务的一个**单项连接**。即如果想要建立双向的安全交换则需要两个安全关联。SA提供的服务取决于所选的安全协议（AH或ESP，二者只能选其一）

简单来说，通信双方如果要用IPSec建立[一条](https://link.zhihu.com/?target=http%3A//www.chinabyte.com/keyword/%E4%B8%80%E6%9D%A1/)安全的传输通路，需要事先协商好将要采用的安全策略，包括使用的加密算法、密钥、密钥的生存期等。当双方协商好使用的安全策略后，我们就说双方建立了一个SA。

#### 包含参数

一个安全关联由下面3个参数唯一确定：

- 安全参数索引号（SPI）：一个与SA相关的位串，由AH和ESP携带，使得接收方能选择合适的SA处理数据包。
- IP目的地址：只允许使用单一地址，表示SA的目的地址。
- 安全协议标识：标识该SA是AH安全关联或ESP安全关联。

### 3.2 认证报头（AH）

用于提供消息认证的扩展头

### 3.3  封装安全载荷（ESP）

封装安全载荷（ESP）定义在RFC2406中，用于为IP提供**保密性和抗重播服务**，包括数据包内容的保密性和有限的流量保密性。作为可选的功能，ESP也提供和AH鉴别头部同样的数据完整性和兼备服务。由于ESP要对数据进行加密处理，因而它比AH需要更多的处理时间。

### 3.4 因特网密钥交换（IKE）

　IKE协议主要是对密钥交换进行管理，它主要包括三个功能。

- 对使用的协议、加密算法和密钥进行协商。
-  方便的密钥交换机制(这可能需要周期性地进行)。
-  跟踪对以上这些约定的实施。

## 4. IPSec的工作模式

AH 和 ESP 都支持两种使用模式：传输模式和隧道模式。

### 传输模式

传输模式主要为上层协议提供保护，且传输模式只对IP包载荷提供保护（加密和认证）。通常情况下，传输模式用于在两个主机之间进行**端对端**的通信。传输模式下，ESP负责加密和认证（认证可选）IP载荷，但不包过IP报头。AH认证IP的载荷和报头。

当主机在IPv4上运行AH或ESP时，其载荷通常是接在IP报头后面的数据，而对IPv6而言，载荷通常是接在IP报头后面的数据和任何存在的IPv6扩展报头。

### 隧道模式

在隧道模式中，IPSec对整个IP包提供保护（加密和认证）。在 AH 或 ESP域添加到IP包后，整个包加上安全域组合成一个**带有新外部IP报头的新“外部”IP包的载荷**（此时可以起到NAT的作用）。整个IP包通过“隧道”从一个节点传输到另一个节点，沿途的路由器不能检查颞部的IP报头。由于对原始IP包的封装，新的包具有完全不同的源地址和目的地址，所以更加安全。（一股NAT味，类似于有加密、认证功能的NAT）

|      | 传输模式SA                                                   | 隧道模式SA                                                   |
| :--- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| AH   | 对IP载荷和IP报头的选中部分、IPv6的扩展报头进行认证           | 对整个内部IP包（内部报头和IP载荷）和外部IP报头的选中部分、外部IPv6的扩展报头进行认证 |
| ESP  | 对IP载荷进行认加密（认证可选），对跟在ESP后面的任何IPv6扩展报头进行加密 | 对整个内部IP包进行加密（认证可选）                           |



